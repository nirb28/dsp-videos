<!DOCTYPE html>
<html>
<head>
    <title>DSP AI Control Tower - Complete Documentation</title>
</head>
<body>

<h1>DSP AI Control Tower</h1>

<ac:structured-macro ac:name="info">
    <ac:rich-text-body>
        <p>Control Tower is the centralized configuration and policy management system for the DSP AI Platform. It provides manifest management, OPA policy enforcement, and serves as the single source of truth for all AI services.</p>
    </ac:rich-text-body>
</ac:structured-macro>

<h2>Table of Contents</h2>
<ac:structured-macro ac:name="toc">
    <ac:parameter ac:name="maxLevel">3</ac:parameter>
</ac:structured-macro>

<hr/>

<h2>Overview</h2>

<h3>What is Control Tower?</h3>
<p>Control Tower is a FastAPI-based application that provides:</p>
<ul>
    <li><strong>Project Manifest Management</strong> - Centralized configuration storage</li>
    <li><strong>Module Configuration</strong> - 12 different module types</li>
    <li><strong>Policy-Based Access Control</strong> - OPA (Open Policy Agent) integration</li>
    <li><strong>Environment Management</strong> - Multi-environment support with variable substitution</li>
    <li><strong>Cross-Service Dependencies</strong> - Automated dependency tracking and validation</li>
</ul>

<h3>Key Features</h3>
<ac:structured-macro ac:name="panel">
    <ac:parameter ac:name="title">Core Capabilities</ac:parameter>
    <ac:rich-text-body>
        <ul>
            <li>RESTful API for all operations</li>
            <li>JSON-based manifest system</li>
            <li>OPA policy evaluation</li>
            <li>HPC job template generation</li>
            <li>Environment variable resolution</li>
            <li>Module cross-referencing</li>
            <li>Validation and dependency checking</li>
        </ul>
    </ac:rich-text-body>
</ac:structured-macro>

<hr/>

<h2>Architecture</h2>

<h3>Component Diagram</h3>
<ac:structured-macro ac:name="code">
    <ac:parameter ac:name="language">text</ac:parameter>
    <ac:plain-text-body><![CDATA[
┌─────────────────────────────────────────────────────────┐
│                    Control Tower                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │   FastAPI    │  │   Manifest   │  │     OPA      │ │
│  │   Layer      │──│    System    │──│    Engine    │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
│         │                  │                  │        │
│         └──────────────────┴──────────────────┘        │
│                           │                            │
│                  ┌────────┴────────┐                   │
│                  │  Storage Layer  │                   │
│                  └─────────────────┘                   │
└─────────────────────────────────────────────────────────┘
           │              │              │
           ▼              ▼              ▼
    ┌──────────┐   ┌──────────┐   ┌──────────┐
    │  Front   │   │   JWT    │   │  APISIX  │
    │  Door    │   │ Service  │   │ Gateway  │
    └──────────┘   └──────────┘   └──────────┘
    ]]></ac:plain-text-body>
</ac:structured-macro>

<h3>Core Components</h3>
<table>
    <thead>
        <tr>
            <th>Component</th>
            <th>Description</th>
            <th>Technology</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><strong>FastAPI Layer</strong></td>
            <td>RESTful API endpoints for all operations</td>
            <td>Python FastAPI</td>
        </tr>
        <tr>
            <td><strong>Manifest System</strong></td>
            <td>JSON-based project configurations</td>
            <td>Pydantic models</td>
        </tr>
        <tr>
            <td><strong>OPA Integration</strong></td>
            <td>Policy engine for access control</td>
            <td>Open Policy Agent (Rego)</td>
        </tr>
        <tr>
            <td><strong>Module Registry</strong></td>
            <td>Catalog of available modules</td>
            <td>File-based storage</td>
        </tr>
        <tr>
            <td><strong>Storage Layer</strong></td>
            <td>Persistent configuration storage</td>
            <td>File system / Database</td>
        </tr>
    </tbody>
</table>

<hr/>

<h2>Module Types</h2>

<p>Control Tower supports 12 module types for comprehensive AI platform configuration:</p>

<ac:structured-macro ac:name="expand">
    <ac:parameter ac:name="title">View All Module Types</ac:parameter>
    <ac:rich-text-body>
        <table>
            <thead>
                <tr>
                    <th>Module Type</th>
                    <th>Purpose</th>
                    <th>Key Configuration</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>jwt_config</strong></td>
                    <td>Authentication and authorization</td>
                    <td>Secret key, algorithm, expiration</td>
                </tr>
                <tr>
                    <td><strong>rag_config</strong></td>
                    <td>Retrieval Augmented Generation</td>
                    <td>Vector store, embeddings, reranking</td>
                </tr>
                <tr>
                    <td><strong>api_gateway</strong></td>
                    <td>Request routing and management</td>
                    <td>Routes, plugins, upstreams</td>
                </tr>
                <tr>
                    <td><strong>inference_endpoint</strong></td>
                    <td>LLM model serving</td>
                    <td>Model, endpoint, parameters</td>
                </tr>
                <tr>
                    <td><strong>security</strong></td>
                    <td>Security policies and compliance</td>
                    <td>Encryption, access control, audit</td>
                </tr>
                <tr>
                    <td><strong>monitoring</strong></td>
                    <td>Observability and metrics</td>
                    <td>Logging, metrics, tracing</td>
                </tr>
                <tr>
                    <td><strong>model_registry</strong></td>
                    <td>Model versioning and lifecycle</td>
                    <td>Registry URL, storage, metadata</td>
                </tr>
                <tr>
                    <td><strong>data_pipeline</strong></td>
                    <td>ETL/ELT workflows</td>
                    <td>Sources, transformations, targets</td>
                </tr>
                <tr>
                    <td><strong>deployment</strong></td>
                    <td>Environment-specific deployment</td>
                    <td>Replicas, resources, scaling</td>
                </tr>
                <tr>
                    <td><strong>resource_management</strong></td>
                    <td>Compute and storage allocation</td>
                    <td>CPU, memory, GPU, storage</td>
                </tr>
                <tr>
                    <td><strong>notifications</strong></td>
                    <td>Alerting and notification channels</td>
                    <td>Email, Slack, webhooks</td>
                </tr>
                <tr>
                    <td><strong>backup_recovery</strong></td>
                    <td>Data backup and disaster recovery</td>
                    <td>Schedule, retention, restore</td>
                </tr>
            </tbody>
        </table>
    </ac:rich-text-body>
</ac:structured-macro>

<hr/>

<h2>Getting Started</h2>

<h3>Installation</h3>

<ac:structured-macro ac:name="code">
    <ac:parameter ac:name="language">bash</ac:parameter>
    <ac:parameter ac:name="title">Setup Commands</ac:parameter>
    <ac:plain-text-body><![CDATA[
# Clone repository
git clone https://github.com/dsp/control-tower.git
cd control-tower

# Create virtual environment
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# Install dependencies
pip install -r requirements.txt

# Start Control Tower
python app.py
    ]]></ac:plain-text-body>
</ac:structured-macro>

<ac:structured-macro ac:name="info">
    <ac:parameter ac:name="title">Default Port</ac:parameter>
    <ac:rich-text-body>
        <p>Control Tower runs on <strong>http://localhost:8000</strong> by default</p>
    </ac:rich-text-body>
</ac:structured-macro>

<h3>Quick Start Example</h3>

<ac:structured-macro ac:name="code">
    <ac:parameter ac:name="language">bash</ac:parameter>
    <ac:parameter ac:name="title">Basic API Calls</ac:parameter>
    <ac:plain-text-body><![CDATA[
# List all manifests
curl http://localhost:8000/manifests

# Get specific manifest
curl http://localhost:8000/manifests/ai-customer-service

# Create new manifest
curl -X POST http://localhost:8000/manifests \
  -H "Content-Type: application/json" \
  -d @manifest.json

# Evaluate policy
curl -X POST http://localhost:8000/evaluate \
  -H "Content-Type: application/json" \
  -d '{
    "input_data": {
      "user": {"role": "developer"},
      "action": "deploy"
    },
    "client_id": "my-client",
    "client_secret": "secret123"
  }'
    ]]></ac:plain-text-body>
</ac:structured-macro>

<hr/>

<h2>API Reference</h2>

<h3>Manifest Endpoints</h3>

<table>
    <thead>
        <tr>
            <th>Method</th>
            <th>Endpoint</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>GET</code></td>
            <td><code>/manifests</code></td>
            <td>List all project manifests</td>
        </tr>
        <tr>
            <td><code>POST</code></td>
            <td><code>/manifests</code></td>
            <td>Create new manifest (requires superuser)</td>
        </tr>
        <tr>
            <td><code>GET</code></td>
            <td><code>/manifests/{id}</code></td>
            <td>Get specific manifest</td>
        </tr>
        <tr>
            <td><code>PUT</code></td>
            <td><code>/manifests/{id}</code></td>
            <td>Update manifest (requires superuser)</td>
        </tr>
        <tr>
            <td><code>DELETE</code></td>
            <td><code>/manifests/{id}</code></td>
            <td>Delete manifest (requires superuser)</td>
        </tr>
        <tr>
            <td><code>POST</code></td>
            <td><code>/manifests/validate</code></td>
            <td>Validate manifest structure</td>
        </tr>
    </tbody>
</table>

<h3>Module Endpoints</h3>

<table>
    <thead>
        <tr>
            <th>Method</th>
            <th>Endpoint</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>GET</code></td>
            <td><code>/manifests/{id}/modules</code></td>
            <td>Get all modules in manifest</td>
        </tr>
        <tr>
            <td><code>GET</code></td>
            <td><code>/manifests/{id}/modules/{name}</code></td>
            <td>Get specific module</td>
        </tr>
        <tr>
            <td><code>GET</code></td>
            <td><code>/module-types</code></td>
            <td>List available module types</td>
        </tr>
    </tbody>
</table>

<h3>Policy Endpoints</h3>

<table>
    <thead>
        <tr>
            <th>Method</th>
            <th>Endpoint</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td><code>GET</code></td>
            <td><code>/policies</code></td>
            <td>List all OPA policies</td>
        </tr>
        <tr>
            <td><code>POST</code></td>
            <td><code>/evaluate</code></td>
            <td>Evaluate policy with input data</td>
        </tr>
        <tr>
            <td><code>POST</code></td>
            <td><code>/batch-evaluate</code></td>
            <td>Batch policy evaluation</td>
        </tr>
    </tbody>
</table>

<hr/>

<h2>Manifest Configuration</h2>

<h3>Basic Manifest Structure</h3>

<ac:structured-macro ac:name="code">
    <ac:parameter ac:name="language">json</ac:parameter>
    <ac:parameter ac:name="title">Example Manifest</ac:parameter>
    <ac:plain-text-body><![CDATA[
{
  "project_id": "ai-customer-service",
  "name": "AI Customer Service Platform",
  "version": "1.0.0",
  "description": "Customer service AI with LLM and RAG",
  "environment": "production",
  "environments": {
    "development": {
      "secrets": {
        "jwt_secret": "dev-secret-key"
      },
      "urls": {
        "api_base": "http://localhost:8000"
      }
    },
    "production": {
      "secrets": {
        "jwt_secret": "${PROD_JWT_SECRET}"
      },
      "urls": {
        "api_base": "https://api.production.com"
      }
    }
  },
  "modules": [
    {
      "name": "auth-service",
      "type": "jwt_config",
      "config": {
        "secret_key": "${environments.${environment}.secrets.jwt_secret}",
        "algorithm": "HS256",
        "expiration_minutes": 30,
        "refresh_token_enabled": true
      }
    },
    {
      "name": "llm-inference",
      "type": "inference_endpoint",
      "config": {
        "model": "gpt-4",
        "endpoint": "${LLM_ENDPOINT}",
        "max_tokens": 2000,
        "temperature": 0.7
      },
      "cross_references": {
        "authentication": {
          "module_name": "auth-service",
          "module_type": "jwt_config",
          "purpose": "JWT token validation",
          "required": true
        }
      }
    }
  ]
}
    ]]></ac:plain-text-body>
</ac:structured-macro>

<h3>Environment Variables</h3>

<ac:structured-macro ac:name="tip">
    <ac:parameter ac:name="title">Variable Substitution</ac:parameter>
    <ac:rich-text-body>
        <p>Control Tower supports three types of variable substitution:</p>
        <ul>
            <li><code>${VARIABLE}</code> - OS environment variables</li>
            <li><code>${environment}</code> - Current environment name</li>
            <li><code>${environments.${environment}.key}</code> - Environment-specific values</li>
        </ul>
    </ac:rich-text-body>
</ac:structured-macro>

<hr/>

<h2>OPA Policy Management</h2>

<h3>Policy Structure</h3>

<ac:structured-macro ac:name="code">
    <ac:parameter ac:name="language">rego</ac:parameter>
    <ac:parameter ac:name="title">Example OPA Policy</ac:parameter>
    <ac:plain-text-body><![CDATA[
package customer_service

# Client authentication
client_secret := "customer_service_secret_123"

# Default deny
default allow = false

# Allow data scientists to perform inference
allow {
    input.user.role == "data_scientist"
    input.action == "infer"
    input.resource.type == "llm_model"
    input.resource.status == "approved"
}

# Allow developers to deploy models
allow {
    input.user.role == "developer"
    input.action == "deploy"
    input.resource.monitoring.active == true
}

# Deny if model is not approved
deny {
    input.resource.status != "approved"
}
    ]]></ac:plain-text-body>
</ac:structured-macro>

<h3>Adding a New Client</h3>

<ol>
    <li>Create policy file: <code>policies/clients/client_name.rego</code></li>
    <li>Define client secret in the policy</li>
    <li>Write authorization rules</li>
    <li>Test with client credentials</li>
</ol>

<hr/>

<h2>Best Practices</h2>

<ac:structured-macro ac:name="panel">
    <ac:parameter ac:name="bgColor">#E3FCEF</ac:parameter>
    <ac:parameter ac:name="title">Configuration Best Practices</ac:parameter>
    <ac:rich-text-body>
        <ul>
            <li><strong>Version Control</strong> - Store manifests in Git</li>
            <li><strong>Environment Separation</strong> - Use environment-specific configurations</li>
            <li><strong>Secret Management</strong> - Never hardcode secrets, use environment variables</li>
            <li><strong>Validation</strong> - Always validate manifests before deployment</li>
            <li><strong>Documentation</strong> - Document module dependencies and purposes</li>
            <li><strong>Testing</strong> - Test policies with various input scenarios</li>
        </ul>
    </ac:rich-text-body>
</ac:structured-macro>

<ac:structured-macro ac:name="panel">
    <ac:parameter ac:name="bgColor">#FFF0B3</ac:parameter>
    <ac:parameter ac:name="title">Security Best Practices</ac:parameter>
    <ac:rich-text-body>
        <ul>
            <li><strong>Principle of Least Privilege</strong> - Grant minimum required permissions</li>
            <li><strong>Policy Versioning</strong> - Track policy changes in version control</li>
            <li><strong>Audit Logging</strong> - Log all policy evaluations</li>
            <li><strong>Regular Reviews</strong> - Periodically review and update policies</li>
            <li><strong>Secret Rotation</strong> - Regularly rotate client secrets</li>
        </ul>
    </ac:rich-text-body>
</ac:structured-macro>

<hr/>

<h2>Troubleshooting</h2>

<h3>Common Issues</h3>

<ac:structured-macro ac:name="expand">
    <ac:parameter ac:name="title">Manifest Validation Errors</ac:parameter>
    <ac:rich-text-body>
        <p><strong>Problem:</strong> Manifest fails validation</p>
        <p><strong>Solutions:</strong></p>
        <ul>
            <li>Check JSON syntax with a validator</li>
            <li>Verify all required fields are present</li>
            <li>Ensure module types are valid</li>
            <li>Check cross-references point to existing modules</li>
        </ul>
    </ac:rich-text-body>
</ac:structured-macro>

<ac:structured-macro ac:name="expand">
    <ac:parameter ac:name="title">Policy Evaluation Failures</ac:parameter>
    <ac:rich-text-body>
        <p><strong>Problem:</strong> Policy evaluation returns unexpected results</p>
        <p><strong>Solutions:</strong></p>
        <ul>
            <li>Verify client_id and client_secret are correct</li>
            <li>Check policy file exists in policies/clients/</li>
            <li>Review Rego syntax for errors</li>
            <li>Test policy with OPA playground</li>
        </ul>
    </ac:rich-text-body>
</ac:structured-macro>

<ac:structured-macro ac:name="expand">
    <ac:parameter name="title">Environment Variable Resolution</ac:parameter>
    <ac:rich-text-body>
        <p><strong>Problem:</strong> Variables not resolving correctly</p>
        <p><strong>Solutions:</strong></p>
        <ul>
            <li>Verify environment variables are set</li>
            <li>Check variable syntax: <code>${VAR_NAME}</code></li>
            <li>Use <code>?resolve_env=true</code> query parameter</li>
            <li>Review environment configuration in manifest</li>
        </ul>
    </ac:rich-text-body>
</ac:structured-macro>

<hr/>

<h2>Related Documentation</h2>

<ul>
    <li><ac:link><ri:page ri:content-title="Front Door Documentation"/></ac:link></li>
    <li><ac:link><ri:page ri:content-title="JWT Service Documentation"/></ac:link></li>
    <li><ac:link><ri:page ri:content-title="Integration Guide"/></ac:link></li>
</ul>

<hr/>

<ac:structured-macro ac:name="info">
    <ac:parameter ac:name="title">Need Help?</ac:parameter>
    <ac:rich-text-body>
        <p>For additional support:</p>
        <ul>
            <li>Check the <a href="http://localhost:8000/docs">API Documentation</a></li>
            <li>Review example manifests in the repository</li>
            <li>Contact the DSP AI Platform team</li>
        </ul>
    </ac:rich-text-body>
</ac:structured-macro>

</body>
</html>
